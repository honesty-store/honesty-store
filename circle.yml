machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  environment:
    REACT_APP_STRIPE_PUBLISHABLE_KEY: $([ $CIRCLE_BRANCH = 'live' ] && echo pk_live_koh6JFFsmJxYyGBok5DHRtJZ || echo pk_test_Lp6VONbqz8TbbnD4oFThDBmT)
    TEST_STRIPE_KEY: sk_test_qqeGkZVE30FLH76H2g2Fd4NL
    PUBLIC_URL: $([ $CIRCLE_BRANCH = 'live' ] && echo https://honesty.store || echo https://$CIRCLE_BRANCH.honesty.store)
  node:
    version: v6.1.0
  services:
    - docker
dependencies:
  cache_directories:
    - ~/.cache/yarn
    - api/node_modules
    - item/node_modules
    - aws/node_modules
    - transaction/node_modules
    - user/node_modules
    - web/node_modules
    - topup/node_modules
    - service/node_modules
    - test/node_modules
    - support/node_modules
    - survey/node_modules
    - box/node_modules
    - batch/node_modules
    - scripts/node_modules
    - store/node_modules
  override:
    - yarn install
    - yarn run bootstrap
compile:
  override:
    - yarn run tslint
    - cd api && yarn run build
    - cd item && yarn run build
    - cd aws && yarn run build
    - cd transaction && yarn run build
    - cd user && yarn run build
    - cd web && yarn run ci
    - cd topup && yarn run build
    - cd service && yarn run ci
    - cd test && yarn run build
    - cd support && yarn run build
    - cd survey && yarn run build
    - cd box && yarn run ci
    - cd batch && yarn run build
    - cd scripts && yarn run build
    - cd store && yarn run build
test:
  override:
    - echo we ran them as part of compile
deployment:
  aws:
    branch: /.*/
    commands:
      # currently we don't deploy support - it contains scripts intended to be locally-run
      - ./aws/bin/aws deploy $CIRCLE_BRANCH api batch item transaction user web topup survey box store
      - ./aws/bin/aws prune
general:
  # attempt to speed up artifact collection by specifying an empty list
  artifacts: []
experimental:
  notify:
    branches:
      only:
        - live
        - test
